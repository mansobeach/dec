%
% Elecnor Deimos
%
% Data Exchange Component
%
% Borja Lopez Fernandez (BOLF)
%
% DEC Install information
%

\documentclass[dec_sum_main.tex]{subfiles}
 
\begin{document}

\section{Install OS Dependencies}
 DEC SW is compatible with any POSIX OS. The information contained in this section aims to ensure that the ruby interpreter can be built at the target platform ; this approach aims for active obsolescence management allowing to make usage of recent stable versions avoiding lock-down by the OS distribution packages, which are usually very constraining in this respect. The SW packages are the very few which are requiring an OS administrator profile (i.e. root user) whilst DEC SW is recommended to live in the OS user environment which will execute it.
 
 \subsection{Debian / Ubuntu based distributions}
 The packages required for Linux distributions based on Debian package manager are listed below:
 \par
 \noindent
 \inlinecode{bash}{ \$> apt-get install curl}  \newline
 \inlinecode{bash}{ \$> apt-get install libcurl4-openssl-dev}  \newline 
 \inlinecode{bash}{ \$> apt-get install git}  \newline
 \inlinecode{bash}{ \$> apt-get install jq}  \newline
 \inlinecode{bash}{ \$> apt-get install libssl-dev}  \newline
 \inlinecode{bash}{ \$> apt-get install sshpass}  \newline
 \inlinecode{bash}{ \$> apt-get install libsqlite3-dev}  \newline
 \inlinecode{bash}{ \$> apt-get install sqlite3}  \newline
 \inlinecode{bash}{ \$> apt-get install libpq-dev}  \newline
 \inlinecode{bash}{ \$> apt-get install libxml2-utils}  \newline
 \inlinecode{bash}{ \$> apt-get install ncftp}  \newline
 \inlinecode{bash}{ \$> apt-get install p7zip-full}  \newline

\subsection{Red-Hat based distributions}
 The installation of packages with RHEL based distributions are constrained by the repositories configured ; official RHEL lack yum support for some of the above SW packages listed in previous section for Debian / Ubuntu based distributions. 
 
  The packages required for Linux distributions based on Red-Hat based distributions are listed below:
  \par
  \noindent
  \inlinecode{bash}{ \$> dnf groupinstall "Development Tools"}  \newline
  \inlinecode{bash}{ \$> yum -y install perl-IPC-Cmd}  \newline 
  \inlinecode{bash}{ \$> yum install curl}  \newline
  \inlinecode{bash}{ \$> yum install curl-devel}  \newline 
  \inlinecode{bash}{ \$> apt-get install sshpass}  \newline
  \inlinecode{bash}{ \$> dnf install sqlite}  \newline
  \inlinecode{bash}{ \$> apt-get install sqlite-devel}  \newline
  \inlinecode{bash}{ \$> yum install -y openssl-devel}  \newline
  \inlinecode{bash}{ \$> yum install -y libxml2}  \newline
  
 \par
 \noindent 
 The following dependencies can be installed manually using rpm available at Nexus:
 \begin{Verbatim}
 ncftp-3.2.5-18.el8.x86_64.rpm
 p7zip-16.02-20.el7.x86_64.rpm
 sshpass-1.09-4.el8.x86_64.rpm
 \end{Verbatim}
 
 \inlinecode{bash}{ \$> yum install -y libxml2}  \newline
 
 
 \subsection{macOS}
  The installation of SW dependencies in macOS can be resolved in different ways ; the tools which are not natively available with the OS or XCode development environment are installed using the package manager "brew" ; openssl is however shipped with macOS but its underlying library libressl does not support some of the algorithms used, therefore it is required to install it with brew and ensure its execution prevails over the native version.
 \par
  \noindent
  \inlinecode{bash}{ \$> brew install jq}  \newline
  \inlinecode{bash}{ \$> brew install ncftp}  \newline
  \inlinecode{bash}{ \$> brew install openssl}  \newline
  \inlinecode{bash}{ \$> brew install p7zip}  \newline
 \par
 \noindent
 
 

\section{Install Ruby}
 This section covers the install of \textit{Ruby} interpreter and the \textit{gem} dependencies needed by DEC SW. It is recommended that the \textit{Ruby} interpreter is done locally for the Linux user who shall execute the DEC SW.\newline

\par
\noindent 
The \textit{Ruby} interpreter can be obtained and installed in many different ways ; this manual describes how to install it local to the OS user which shall execute the DEC SW. Different runtime managers are addressed in the following sections to ease the installation and eventual futures updates in a seamless manner.

\subsection{asdf}
\par
\noindent
This section addresses how to install ruby based on \href{https://asdf-vm.com/guide/getting-started.html#_1-install-dependencies}{asdf}, which is a command-line tool run-time manager for different languages and development stacks, including ruby.\newline

\par
\noindent
Download the tool:

\inlinecode{bash}{ \$> git clone https://github.com/asdf-vm/asdf.git ~/.asdf --branch v0.10.2}  \newline

Add the following entry to \$HOME/.bash\_profile 

\inlinecode{bash}{. \$HOME/.asdf/asdf.sh}  \newline


\par
\noindent
Then install / update the asdf ruby plug-in:

\inlinecode{bash}{ \$> asdf plugin add ruby} \newline
\par
\inlinecode{bash}{ \$> asdf plugin update ruby} \newline


\par
\noindent
Now it is possible to select the ruby run-time version and easily install it for usage:\newline

\inlinecode{bash}{ \$> asdf list all ruby}

\begin{Verbatim}
1.8.5-p52
1.8.5-p113
1.8.5-p114
1.8.5-p115
1.8.5-p231
1.8.6
(...)
3.0.0-dev
3.0.0-preview1
3.0.0-preview2
3.0.0-rc1
3.0.0
3.0.1
3.0.2
3.0.3
3.1.0-dev
3.1.0-preview1
3.1.0
3.1.1
3.1.2
3.1.3
3.1.4
3.2.0-dev
(...)
\end{Verbatim}


\par
\noindent
Install the ruby run times specifying the version of choice, first to be downloaded and then to select it for local execution:\newline

\inlinecode{bash}{ \$> asdf install ruby 3.1.4} \newline

\par
\inlinecode{bash}{ \$> asdf local ruby 3.1.4\; asdf reshim ruby}\newline

\par
\noindent
Now it is usually required to restart the shell upon  installation to point the new ruby interpreter run-time.

\subsection{RVM}
\par
\noindent
This section addresses how to install ruby based on \href{https://rvm.io/}{RVM}, which is a command-line tool which allows you to easily install, manage, and work with multiple ruby environments from interpreters to sets of gems. \newline

\par
\inlinecode{bash}{ \$> \\curl -sSL https://get.rvm.io | bash -s stable --ruby} \newline
\par 
\noindent
Alternatively to the latest ruby stable installation, the following command installs a specific version of ruby interpreter ; the version specified below corresponds to the one used for the unit tests and it is required as a mandatory precondition at installation time according to the gem file definition.\newline

\par 
\noindent
Different versions can be locally installed and select the one of choice at any time. However the following ruby version is recommended:

\inlinecode{bash}{ \$> rvm install ruby-3.0} \newline

\inlinecode{bash}{ \$> rvm --default use 3.0} \newline



\section{Download DEC SW}
The natural step is to get the DEC SW gem for installation ; according to the project, the repository or the source of the install kit may differ
is section contains the link to download the DEC SW installer \textit{gemfile} \href{https://nexus3.elecnor-deimos.com/repository/NAOS-IVV/dec/dec-1.0.38a_naos-test_gsc4eo@nl2-u-moc-srv-01.gem}{\textit{dec.gem}} with the unit tests configuration. It is necessary to be logged-in with your DEIMOS \textit{corporate} account in Nexus to \textit{authorise} the download. Do not hesitate in requesting tailored installation packages according to your needs.

\section{Install DEC SW}

In order to install DEC SW and the gems required, execute the following command in the shell at the directory in which the DEC gem file is placed:
\par
\inlinecode{bash}{ \$> gem install dec_stable.gem } \newline
\par

\par
\par
\noindent
It is usually recommended to perform the installation of every DEC node with a dedicated installer, which already carries the desired configuration according to the defined interfaces and the desired behaviour ; this approach makes installations and configuration into the target environment almost instantaneously (e.g. maintenance in Operations). Every DEC node configuration can be kept under configuration control in order to build the dedicated installers.\newline

\noindent
The DEC installer naming file is generated to avoid ambiguity and bring information regarding the node they apply to. Below there are some few examples to illustrate the naming conventions to easily identify the installation kit for a given DEC node configuration.\newline
\par

\inlinecode{bash}{ \$> gem install dec-1.0.32_s2_dec@s2boa-cloudferro.gem } \newline

\inlinecode{bash}{ \$> gem install dec-1.0.33_s2_push_lisboa@e2espm-inputhub.gem } \newline

\inlinecode{bash}{ \$> gem install dec-1.0.33_unit_tests@localhost.gem } \newline

\noindent
Also the DEC installer can be customised to carry or avoid specific SW items, such as the testing tools (i.e. unit tests, interface tests, etc). The installation kit referred below as example has been customised for some Sentinel-2 project to carry the test tools, the OData tools and make usage of postgresql to persist the operations performed \newline

\inlinecode{bash}{ \$> gem install dec-1.0.33_s2_test_pg_odata@localhost.gem } \newline

\noindent
As a very quick summary, users of the SW are encouraged to delegate the creation of the configuration by providing the requirements / interface documents to build dedicated installation packages for every node. 
\par


\section{Uninstall DEC SW}

In order to uninstall DEC SW, execute the following command in the shell:
\par 
\inlinecode{bash}{ \$> gem uninstall dec }
\par 

\begin{verbatim}
Remove executables:
decValidateConfig, decCheckConfig, decCheckSent, decConfigInterface2DB, decDeliverFiles, decGetFiles4Transfer, decGetFromInterface, decListener, decManageDB, decNotify2Interface, decSend2Interface, decSmokeTests, decStats, decUnitTests, decUnitTests_IERS, decUnitTests_ncftpput, decUnitTests_mail

in addition to the gem? [Yn]
\end{verbatim}

Press 'Y' key to remove the executables as well

\label{COTS}
\label{FOSS}
\section{FOSS Required}

This section enumerates the FOSS which are used by DEC SW for exchange of file by some network protocol implementation, or file transformations associated to those exchanges. \par\noindent


\par
\noindent
This manual, which currently address component level information, does not address how to provision these COTS ; they can be obtained naturally with most OS distribution, downloaded with its native package manager, or manually installed. However it is noted that DEC containerized execution environments definition (IaaS) which already resolve every SW COTS dependencies out of the box are available, please do not hesitate in requesting information.

\subsection{Databases}
This section enumerates the different databases which can be used by DEC SW. Only \textit{sqlite3} is \textit{mandatory} to allow the execution of the entire set of \textit{unit tests}. Below the different databases that have used at some deployment. It is recalled that it is possible to execute the DEC SW without any database by usage of flag \textit{"--nodb"}.
\par
\begin{itemize}
	\item \href{https://www.sqlite.org}{\textit{sqlite3}} : is an in-process library that implements a self-contained, serverless, zero-configuration, transactional SQL database engine
	\item \href{https://www.postgresql.org/}{\textit{PostgreSQL}} : object-relational database system with a strong reputation for reliability, feature robustness, and performance
	\item \href{https://www.mysql.com/}{\textit{MySQL}} : a high performance, scalable database management system
\end{itemize}

\subsection{Network Tools}
This section enumerates the network tools which are used by DEC SW.
\par
\begin{itemize}
	\item \href{https://www.ncftp.com}{\textit{ncftp}} : application programs implementing the File Transfer Protocol (FTP)
	\item \href{https://www.openssh.com}{\textit{sftp}} : application programs implementing the Secure File Transfer Protocol (SFTP)
    \item \href{https://linux.die.net/man/1/sshpass}{\textit{sshpass}}: application to handle the SSH password in non interactive mode (SFTP)
	\item \href{https://curl.haxx.se}{\textit{curl}} : command line tool and library for transferring data with URLs (WebDAV)
\end{itemize}

\subsection{File Compression Tools}
This section enumerates the file compression tools which can be used by DEC SW.
\par
\begin{itemize}
	\item \href{https://www.7-zip.org/}{\textit{7-zip}} : is a file archiver with a high compression ratio ; name of the package can be \textit{"p7zip"}
	\item \href{http://infozip.sourceforge.net}{\textit{zip} / \textit{unzip}} : provide free, portable, high-quality versions of the \textit{Zip} and \textit{UnZip} compressor-archiver utilities
	\item \href{https://www.gzip.org}{\textit{gzip}} : The \textit{gzip} reduces the size of the named files using Lempelâ€“Ziv coding (LZ77)
	\item \href{http://man7.org/linux/man-pages/man1/compress.1p.html}{\textit{compress}} : The \textit{compress} utility reduces the size of the named files by using adaptive Lempel-Ziv coding algorithm
\end{itemize}

\subsection{File Transformation Tools}
This section enumerates the file transformation tools which can be used by DEC SW.

\begin{itemize}
	\item \href{http://xmlsoft.org/xmllint.html}{\textit{xmllint}} : is a command line XML parser which is part of the \href{http://xmlsoft.org}{\textit{libxml2}} and libxml2-utils packages.
    \item \href{https://stedolan.github.io/jq/}{\textit{jq}} : jq is a lightweight and flexible command-line JSON processor.	
\end{itemize}

\subsection{Encryption Tools}
DEC SW makes usage of \href{https://www.openssl.org/}{\textit{openssl}} toolkit to support the encryption of sensible configuration items. The version installed of openssl needs to support the algorithm PBKDF2.

\section{Installation Verification}
\subsection{Verification with Unit Tests}
This section describes how to execute the \textit{unit tests}, which have been designed to be transparent and harmless in front of the potential different execution environments (i.e. development, integration, production), being their execution a simple and effective manner to verify the correct installation of the DEC SW. \newline
\par
The prerequisites to be able to successfully execute the \textit{unit tests} are :
\begin{itemize}
	\item an OS user \textit{dectest}
	\item SFTP server running on \textit{localhost} allowing login to \textit{dectest} using the SSH keys
	\item FTP server running on \textit{localhost} allowing login to \textit{dectest} using the \textit{password} \textit{dectest} \newline
\end{itemize} 
\par
\inlinecode{bash}{ \$> decUnitTests } \newline

\noindent
The results of the unit test should show no failures neither errors ; the execution time in a 2.66 GHz Intel Core 2 Duo is about 10 minutes approximately.
\lstset{escapeinside={<@}{@>}}
\begin{lstlisting}
.
Finished in 590.39725 seconds.
<@\textcolor{green}{-----------------------------------------------------------------------------------------------------------------------------------------------------------}@>
17 tests, 112 assertions, 0 failures, 0 errors, 0 pendings, 0 omissions, 0 notifications
100% passed
<@\textcolor{green}{-----------------------------------------------------------------------------------------------------------------------------------------------------------}@>
0.03 tests/s, 0.19 assertions/s
\end{lstlisting}

\subsection{Verification with Operational Interface}
This section describes how to verify the correct installation of DEC SW by execution of a test with the IERS \textit{operational} service, for which Internet connectivity is required for the FTP protocol. Note that it is not possible to ensure the connectivity availability by such service and sometimes test may fail by reply of \textit{530 connect failed: Address already in use. No response from server.} \newline

\inlinecode{bash}{ \$> decUnitTests_IERS } \newline

\begin{lstlisting}
.
Finished in 54.38868 seconds.
<@\textcolor{green}{-----------------------------------------------------------------------------------------------------------------------------------------------------------}@>
2 tests, 25 assertions, 0 failures, 0 errors, 0 pendings, 0 omissions, 0 notifications
100% passed
<@\textcolor{green}{-----------------------------------------------------------------------------------------------------------------------------------------------------------}@>
0.02 tests/s, 0.33 assertions/s 
\end{lstlisting}

\noindent
\newline
In case of deployment without any database, the tests can be restricted to the ones which make usage of the \textit{"--nodb"} execution option:

\inlinecode{bash}{ \$> decUnitTests_IERS -n test_decGetFromInterface_NODB} \newline

\begin{lstlisting}
.
Finished in 54.38868 seconds.
<@\textcolor{green}{-----------------------------------------------------------------------------------------------------------------------------------------------------------}@>
1 tests, 18 assertions, 0 failures, 0 errors, 0 pendings, 0 omissions, 0 notifications
100% passed
<@\textcolor{green}{-----------------------------------------------------------------------------------------------------------------------------------------------------------}@>
0.02 tests/s, 0.23 assertions/s
\end{lstlisting}

\section{DEC App Container}
It is not strictly in the scope of this reference manual to describe the different integration and deployment strategies to make usage of the DEC SW. However it is considered valuable to document that the SW is ready for containerization (i.e. docker containers) and that such deployment strategy has been successfully used to design full standalone nodes including also standard TCP/IP servers to hub all the interface connections. In this respect there are available some dockerfiles IaaS to define the node SW dependencies in different execution environments (i.e. IVV, Production).

\par
\noindent
\newline
The files to be pushed or the files pulled to be made available to the end-peers are usually exchanged in the host which runs the container. Hence the execution of the DEC App container needs some mount point in the host ; this aspect is managed seamlessly by the different SW handling containers execution (i.e. docker, kubernetes, podman).

\par
\noindent
\newline
The DEC SW can be managed from the command line interface as it were natively installed in the host. As such the command reference of this manual can be used by just pointing to the DEC container by some alias definition invoking the execution for which the execution arguments are naturally appended:
\begin{verbatim}
alias decCheckConfig='podman exec dec decCheckConfig'
alias decConfigInterface2DB='podman exec dec decConfigInterface2DB'
alias decDeliverFiles='podman exec dec decDeliverFiles'
alias decGetFromInterface='podman exec dec decGetFromInterface'
alias decListDirUpload='podman exec dec decListDirUpload'
alias decListener='podman exec dec decListener'
alias decManageDB='podman exec dec decManageDB'
alias decNATS='podman exec dec decNATS'
alias decSend2Interface='podman exec dec decSend2Interface'
alias decStart='podman run --userns keep-id --env '\''USER'\'' --add-host=nl2-s-aut-srv-01:172.23.253.16 --network=host --tz=Europe/London --name dec -d --mount type=bind,source=/data,destination=/data localhost/dec_naos-test_gsc4eo_nl2-u-moc-srv-01:latest'
alias decStats='podman exec dec decStats'
alias decTestInterface_CelesTrak='podman exec -i dec decTestInterface_CelesTrak'
alias decTestInterface_NAOS_IVV-0500='podman exec -i dec decTestInterface_NAOS_IVV-0500'
alias decTestInterface_NASA='podman exec -i dec decTestInterface_NASA'
alias decValidateConfig='podman exec dec decValidateConfig'
\end{verbatim}




\end{document}

